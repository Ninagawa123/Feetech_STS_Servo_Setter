# Feetech STS Servo Setter

ESP32を使用してFeetech STSサーボの設定・制御を行うためのテストコードです。半二重通信回路経由でサーボの詳細制御、ID管理、診断機能を提供します。
(このREADMEはAIで生成しているため、まだご参考程度に。)


## 特徴

- **個別サーボ制御**: Ping、位置読み取り、電圧監視、移動状態確認
- **複数サーボ制御**: SyncWrite機能による同期制御
- **ID管理機能**: サーボID変更、工場出荷時リセット、連番設定
- **診断ツール**: 通信テスト、サーボスキャン、ステータス確認
- **インタラクティブ**: シリアルコンソールでのコマンド入力

## ハードウェア要件

### 対応ボード
- ESP32 (esp32dev)

### 配線
```
ESP32    半二重回路    STSサーボ
GPIO33   EN           -
GPIO27   TX           Data
GPIO32   RX           Data
GND      GND          GND
-        VCC(6-14V)   VCC
```

### サーボ仕様
- **対応機種**: Feetech STS シリーズ（STS3215等）
- **通信速度**: 1Mbps
- **位置分解能**: 4096段階 (0.088°/step)
- **ID範囲**: 1-253

## セットアップ

### 1. PlatformIOでのビルド

```bash
# プロジェクトをクローン
git clone <repository-url>
cd Feetech_STS_Servo_Setter

# ビルド
pio run

# ESP32に書き込み
pio run -t upload

# シリアルモニター起動
pio device monitor
```

### 2. 設定確認

起動後、以下が表示されることを確認：
```
╔══════════════════════════════════════════════════════════╗
║          Feetech STS サーボ設定システム v0.1                ║
╚══════════════════════════════════════════════════════════╝
ENピン状態: 現在LOW(受信)
UART設定: 1Mbps, 8N1, TX=27, RX=32

サーボ接続テスト...
```

## 使用方法

### 基本コマンド

システム起動後、コマンド一覧が表示されます。以下のキーを入力してEnterで実行：

#### 基本制御
- **`p`** - Ping テスト（接続確認）
- **`r`** - 現在位置読み取り
- **`v`** - 電圧読み取り  
- **`m`** - 移動状態確認
- **`c`** - センター移動（2048 = 180°）
- **`s`** - 全ステータス確認

#### 複数サーボ制御
- **`y`** - SyncWrite テスト（3台同期制御）
- **`a`** - 複数位置読み取り
- **`n`** - サーボスキャン（ID 1-5）
- **`e`** - 全トルク有効化
- **`d`** - 全トルク無効化

#### ID管理
- **`j`** - ID読み取り（指定IDの情報表示）
- **`i`** - ID変更（対話式）
- **`f`** - 工場出荷時リセット（ID=1に戻す）
- **`b`** - 連番ID設定（複数サーボの一括設定）

#### その他
- **`z`** - ターゲットサーボID変更
- **`t`** - 通信テスト（10回試行）
- **`h`** - ヘルプ表示

### 使用例

#### 1. 基本的な動作確認
```
p  ← Pingテスト
r  ← 位置読み取り
v  ← 電圧確認
c  ← センター移動
```

#### 2. ID変更の手順
```
i  ← ID変更コマンド
1  ← 現在のID入力
5  ← 新しいID入力
y  ← 確認
```

#### 3. 複数サーボの同期制御
```
n  ← サーボスキャン（接続確認）
e  ← 全トルク有効化
y  ← SyncWriteテスト実行
```

## トラブルシューティング

### 接続エラーの場合
```
ERROR: サーボ接続失敗
```

**確認項目:**
1. **配線確認** - EN(33), TX(27), RX(32), GND
2. **電源確認** - 6-14V供給
3. **サーボID確認** - デフォルト=1
4. **ボーレート確認** - 1Mbps

### よくある問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 応答なし | 配線不良 | 配線を再確認 |
| 位置読み取り失敗 | 電源不足 | 電源電圧確認 |
| ID変更失敗 | EEPROM保護 | 工場リセット後に再試行 |

## 技術仕様

### レジスタアドレス
```cpp
#define REG_ID 5                    // サーボID
#define REG_TORQUE_ENABLE 40        // トルク有効化
#define REG_TARGET_POSITION 30      // 目標位置
#define REG_CURRENT_POSITION 56     // 現在位置
#define REG_VOLTAGE 62              // 電圧
#define REG_MOVING 66               // 移動状態
```

### 通信プロトコル
- **方式**: 半二重UART
- **速度**: 1,000,000 bps
- **データ**: 8bit, パリティなし, ストップビット1
- **タイムアウト**: 8000μs

### 位置制御
- **範囲**: 0-4095 (0-360°)
- **センター**: 2048 (180°)
- **分解能**: 0.088°/step

## ライセンス

MIT License

## 貢献

プルリクエスト、イシューの報告を歓迎します。

## 関連リンク

- [Feetech公式サイト](https://www.feetechrc.com/)
- [STS3215仕様書](https://www.waveshare.com/wiki/ST3215_Servo)
- [PlatformIO](https://platformio.org/)
